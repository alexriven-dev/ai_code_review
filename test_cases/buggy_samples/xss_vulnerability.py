"""
Web Template Rendering
Handles HTML template generation and rendering.
"""

from typing import Dict, Any, List, Optional
from datetime import datetime
import html
import json


class TemplateEngine:
    """Simple template engine for HTML generation."""

    def __init__(self):
        self.templates: Dict[str, str] = {}

    def register_template(self, name: str, template: str):
        """Register a template."""
        self.templates[name] = template

    def render(self, template_name: str, context: dict) -> str:
        """Render a template with context."""
        if template_name not in self.templates:
            raise ValueError(f"Template {template_name} not found")

        template = self.templates[template_name]

        # BUG: Simple string substitution without escaping - XSS vulnerability
        for key, value in context.items():
            template = template.replace(f"{{{{{key}}}}}", str(value))

        return template


class UserProfileRenderer:
    """Renders user profile pages."""

    def render_profile(self, user: dict) -> str:
        """Render a user profile page."""
        # BUG: Directly interpolating user data into HTML - XSS
        return f"""
        <!DOCTYPE html>
        <html>
        <head><title>{user['name']}'s Profile</title></head>
        <body>
            <h1>Welcome, {user['name']}!</h1>
            <div class="bio">{user['bio']}</div>
            <div class="location">Location: {user['location']}</div>
            <div class="website">
                <a href="{user['website']}">Personal Website</a>
            </div>
        </body>
        </html>
        """

    def render_profile_card(self, user: dict) -> str:
        """Render a profile card snippet."""
        # BUG: XSS in multiple places
        return f"""
        <div class="profile-card" data-user-id="{user['id']}">
            <img src="{user['avatar_url']}" alt="{user['name']}'s avatar">
            <h3>{user['name']}</h3>
            <p class="title">{user['title']}</p>
            <p class="bio">{user['bio']}</p>
        </div>
        """

    def render_user_list(self, users: List[dict]) -> str:
        """Render a list of users."""
        items = []
        for user in users:
            # BUG: XSS - no escaping
            items.append(f"<li>{user['name']} - {user['email']}</li>")

        return f"<ul>{''.join(items)}</ul>"


class CommentRenderer:
    """Renders comment sections."""

    def render_comment(self, comment: dict) -> str:
        """Render a single comment."""
        # BUG: XSS in comment content and author name
        return f"""
        <div class="comment" id="comment-{comment['id']}">
            <div class="author">{comment['author']}</div>
            <div class="timestamp">{comment['timestamp']}</div>
            <div class="content">{comment['content']}</div>
        </div>
        """

    def render_comment_form(self, post_id: str) -> str:
        """Render a comment form."""
        # BUG: XSS in post_id (could be manipulated in URL)
        return f"""
        <form action="/posts/{post_id}/comments" method="POST">
            <input type="hidden" name="post_id" value="{post_id}">
            <textarea name="content" placeholder="Write a comment..."></textarea>
            <button type="submit">Post Comment</button>
        </form>
        """

    def render_comment_thread(self, comments: List[dict]) -> str:
        """Render a thread of comments."""
        html_parts = ['<div class="comment-thread">']

        for comment in comments:
            # BUG: Multiple XSS vectors
            html_parts.append(f"""
                <div class="comment">
                    <strong>{comment['author']}</strong>
                    <span class="date">{comment['date']}</span>
                    <p>{comment['text']}</p>
                    <div class="replies" data-parent="{comment['id']}">
            """)

            for reply in comment.get('replies', []):
                # BUG: XSS in replies too
                html_parts.append(f"""
                    <div class="reply">
                        <strong>{reply['author']}</strong>: {reply['text']}
                    </div>
                """)

            html_parts.append('</div></div>')

        html_parts.append('</div>')
        return ''.join(html_parts)


class SearchResultRenderer:
    """Renders search results."""

    def render_search_page(self, query: str, results: List[dict]) -> str:
        """Render search results page."""
        # BUG: XSS - query reflected without escaping
        html = f"""
        <!DOCTYPE html>
        <html>
        <head><title>Search: {query}</title></head>
        <body>
            <h1>Search Results for: {query}</h1>
            <p>Found {len(results)} results</p>
            <div class="results">
        """

        for result in results:
            # BUG: XSS in result title and snippet
            html += f"""
                <div class="result">
                    <a href="{result['url']}">{result['title']}</a>
                    <p>{result['snippet']}</p>
                </div>
            """

        html += """
            </div>
        </body>
        </html>
        """
        return html

    def render_search_suggestions(self, suggestions: List[str]) -> str:
        """Render search suggestions dropdown."""
        items = []
        for suggestion in suggestions:
            # BUG: XSS in suggestions
            items.append(f'<li onclick="search(\'{suggestion}\')">{suggestion}</li>')

        return f'<ul class="suggestions">{"".join(items)}</ul>'


class ErrorPageRenderer:
    """Renders error pages."""

    def render_404(self, path: str) -> str:
        """Render 404 error page."""
        # BUG: XSS - path from URL reflected in page
        return f"""
        <!DOCTYPE html>
        <html>
        <head><title>404 Not Found</title></head>
        <body>
            <h1>Page Not Found</h1>
            <p>The page "{path}" could not be found.</p>
            <a href="/">Go Home</a>
        </body>
        </html>
        """

    def render_error(self, error_message: str, error_code: int) -> str:
        """Render generic error page."""
        # BUG: XSS - error message might contain user input
        return f"""
        <!DOCTYPE html>
        <html>
        <head><title>Error {error_code}</title></head>
        <body>
            <h1>Error {error_code}</h1>
            <p class="error-message">{error_message}</p>
        </body>
        </html>
        """


class JSONRenderer:
    """Renders JSON data in HTML."""

    def render_json_viewer(self, data: dict, title: str) -> str:
        """Render JSON data in an HTML viewer."""
        # BUG: XSS in title
        # Also: json.dumps doesn't escape for HTML context
        json_str = json.dumps(data, indent=2)

        return f"""
        <div class="json-viewer">
            <h3>{title}</h3>
            <pre>{json_str}</pre>
        </div>
        """

    def render_api_response(self, endpoint: str, response: dict) -> str:
        """Render API response for documentation."""
        # BUG: XSS in endpoint name
        return f"""
        <div class="api-response">
            <h4>Response from: {endpoint}</h4>
            <code>{json.dumps(response)}</code>
        </div>
        """


# Example of proper escaping (for reference)
class SafeRenderer:
    """Example of safe rendering (for comparison)."""

    def render_safe_comment(self, comment: dict) -> str:
        """Safely render a comment with proper escaping."""
        return f"""
        <div class="comment">
            <div class="author">{html.escape(comment['author'])}</div>
            <div class="content">{html.escape(comment['content'])}</div>
        </div>
        """


# API handlers
def handle_render_profile(request_data: dict) -> str:
    """Handle profile rendering request."""
    renderer = UserProfileRenderer()

    # User data from database (could contain malicious content)
    user = request_data.get("user", {})

    # BUG: Rendering user data without sanitization
    return renderer.render_profile(user)


def handle_search(request_data: dict) -> str:
    """Handle search request."""
    renderer = SearchResultRenderer()

    # BUG: Query parameter directly from user input
    query = request_data.get("q", "")
    results = []  # Would come from search engine

    return renderer.render_search_page(query, results)


def handle_error(request_data: dict) -> str:
    """Handle error page rendering."""
    renderer = ErrorPageRenderer()

    # BUG: Error message could contain user input
    error_msg = request_data.get("error", "Unknown error")
    error_code = request_data.get("code", 500)

    return renderer.render_error(error_msg, error_code)
